---
title: "Healthier food environments"
subtitle: 
author: "Public Health Evidence & Intelligence"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    toc_depth: 3
    highlight: kate
    self_contained: true
    thumbnails: false
    lightbox: false
    gallery: no
    fig_width: 10
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

box::use(.. / .. / phei_functions / fingertips)
library(reactable)
library(dplyr)

source("R/global.utils.R")

data <- get_data()

table_data <- data$table %>%
  dplyr::mutate(Herts_quintile = ifelse(Herts_quintile == 1, "1 (most deprived)", ifelse(Herts_quintile == 5, "5 (least deprived)", Herts_quintile)))

comparison <- data$comparision
```

```{css, echo = FALSE}
.book .book-body .page-inner {
    max-width: 1500px;
}
```

## Healthier food environments indicators {.tabset}

### Ward table 

```{r}
table_data %>%
  reactable::reactable(
    defaultExpanded = FALSE, defaultSorted = "ward_name", outlined = FALSE, striped = TRUE, highlight = TRUE,
    filterable = TRUE, resizable = TRUE, defaultPageSize = 20,
    columns = list(
      `Prevalence_overweight_and_obesity_Year_6` = colDef(cell = function(value, index) {
        colour <- table_data$Diff_year_6[index]
        if (colour == "significantly higher than") {
          htmltools::div(style = list(fontSize = 14, color = "#e00000", fontWeight = "bold"), value)
        } else if (colour == "significantly lower than") {
          htmltools::div(style = list(fontSize = 14, color = "green", fontWeight = "bold"), value)
        } else {
          htmltools::div(style = list(fontSize = 14), value)
        }
      }, html = TRUE, name = "Year 6: Prevalence of overweight and obesity"),
      `Prevalence_overweight_and_obesity_Reception` = colDef(cell = function(value, index) {
        colour <- table_data$Diff_Reception[index]
        if (colour == "significantly higher than") {
          htmltools::div(style = list(fontSize = 14, color = "#e00000", fontWeight = "bold"), value)
        } else if (colour == "significantly lower than") {
          htmltools::div(style = list(fontSize = 14, color = "green", fontWeight = "bold"), value)
        } else {
          htmltools::div(style = list(fontSize = 14), value)
        }
      }, html = TRUE, name = "Reception: Prevalence of overweight and obesity"),
      `Prevalence_obesity_Year_6` = colDef(cell = function(value, index) {
        colour <- table_data$Diff_year_6_obesity[index]
        if (colour == "significantly higher than") {
          htmltools::div(style = list(fontSize = 14, color = "#e00000", fontWeight = "bold"), value)
        } else if (colour == "significantly lower than") {
          htmltools::div(style = list(fontSize = 14, color = "green", fontWeight = "bold"), value)
        } else {
          htmltools::div(style = list(fontSize = 14), value)
        }
      }, html = TRUE, name = "Year 6: Prevalence of obesity"),
      `Prevalence_obesity_Reception` = colDef(cell = function(value, index) {
        colour <- table_data$Diff_Reception_obesity[index]
        if (colour == "significantly higher than") {
          htmltools::div(style = list(fontSize = 14, color = "#e00000", fontWeight = "bold"), value)
        } else if (colour == "significantly lower than") {
          htmltools::div(style = list(fontSize = 14, color = "green", fontWeight = "bold"), value)
        } else {
          htmltools::div(style = list(fontSize = 14), value)
        }
      }, html = TRUE, name = "Reception: Prevalence of obesity"),
      # Herts_quintile = colDef(align = "left",cell = function(value, index){
      #   if(value <= 1 & !is.na(value)){
      #     htmltools::div(style = list(fontSize = 14, color = "#e00000", fontWeight = "bold"), value)
      #   }
      #   else if(value >= 5 & !is.na(value)){
      #     htmltools::div(style = list(fontSize = 14, color = "green", fontWeight = "bold"), value)
      #   } else{
      #     htmltools::div(style = list(fontSize = 14), value)
      #   }
      # }, html = TRUE, name = "Herts IMD deprivation quintile"),
      fast_food_rate = colDef(cell = function(value, index) {
        colour <- table_data$fast_food_diff[index]
        if (colour == "significantly higher than") {
          htmltools::div(style = list(fontSize = 14, color = "#e00000", fontWeight = "bold"), value)
        } else if (colour == "significantly lower than") {
          htmltools::div(style = list(fontSize = 14, color = "green", fontWeight = "bold"), value)
        } else {
          htmltools::div(style = list(fontSize = 14), value)
        }
      }, html = TRUE, name = "Fast food rate per 1000 population"),
      Diff_Reception = colDef(show = FALSE),
      Diff_year_6 = colDef(show = FALSE),
      Diff_Reception_obesity = colDef(show = FALSE),
      Diff_year_6_obesity = colDef(show = FALSE),
      ward_name = colDef(name = "Ward"),
      district_name = colDef(name = "District"),
      county = colDef(name = "County"),
      Herts_quintile = colDef(name = "Herts IMD deprivation quintile"),
      # HWE_quintile = colDef(show = FALSE),
      fast_food_diff = colDef(show = FALSE)
    )
  )
```

### Comparison table

```{r}
comparison %>%
  dplyr::select(IndicatorName, everything()) %>%
  reactable::reactable(
    outlined = FALSE, striped = TRUE, highlight = TRUE,
    filterable = FALSE, resizable = TRUE, defaultPageSize = 20,
    columns = list(
      IndicatorName = colDef(name = "Indicator"),
      AreaName = colDef(name = "Comparator area"),
      value = colDef(name = "Value"),
      lowercl = colDef(show = FALSE),
      uppercl = colDef(show = FALSE)
    )
  )
```


## {.unlisted .unnumbered}

## Data Guidance

Herts IMD deprivation quintile: The Index of Multiple Deprivation (IMD) 2019 is an overall measure of relative deprivation. Hertfordshire is relatively less deprived than England so local deprivation quinitles have been used to highlight differences locally. Quintile 1 is the most deprived quintile and quintile 5 the least deprived. The most deprived quintile 1 is  highlighted in red, the least deprived quintile is highlighted in green.<br><br>

Prevalence of overweight and obesity in year 6 and reception: This indicators shows the percentage of pupils who were classified as overweight or obese, it combines 3 years of data (2019/20-2021/22). Values highlighted in red are significantly higher than the Hertfordshire average and those highlighted in green are significantly lower than Hertfordshire. Values with numerators of less than 7 have been suppressed (*) and all numerators and denominators have been rounded to the nearest 5.<br><br>

Prevalence of obesity in year 6 and reception: This indicator shows the percentage of pupils who were classified as obese, it combines 3 years of data (2019/20-2021/22). Values highlighted in red are significantly higher than the Hertfordshire average and those highlighted in green are significantly lower than Hertfordshire. Values with numerators of less than 7 have been suppressed (*) and all numerators and denominators have been rounded to the nearest 5.<br><br>

Fast food rate per 1000 population: This is the rate of fast food establishments per 1000 population. The following business types were included: Restaurant/Cafe/Canteen, Retailers - supermarkets/hypermarkets, Takeaway/sandwich shop, Mobile caterer and Pub/bar/nightclub. Values highlighted in red have a significantly higher rate than Hertfordshire and those highlighted in green have a significantly lower rate than Hertfordshire.

The comparison table contains the Hertfordshire values the wards have been compared to for each indicator.
